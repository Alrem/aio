---

  - name: Install MCP
    hosts: aio
    gather_facts: no
    tasks:

      - name: state salt
        command: salt-call --hard-crash state.apply salt
        become: yes
        register: saltout

      - name: debug-message for state salt
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state linux,ntp,openssh
        command: salt-call --hard-crash state.apply linux,ntp,openssh
        become: yes
        register: saltout

      - name: debug-message for state linux,ntp,openssh
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state memcached
        command: salt-call --hard-crash state.apply memcached
        become: yes
        register: saltout

      - name: debug-message for state memcached
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state rabbitmq
        command: salt-call --hard-crash state.apply rabbitmq
        become: yes
        register: saltout

      - name: debug-message for state rabbitmq
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state mysql
        command: salt-call --hard-crash state.apply mysql
        become: yes
        register: saltout

      - name: debug-message for state mysql
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state keystone 1
        command: salt-call --hard-crash state.apply keystone
        become: yes

      - name: state keystone 2
        command: salt-call --hard-crash state.apply keystone
        become: yes
        register: saltout

      - name: debug-message for state keystone
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state glance
        command: salt-call --hard-crash state.apply glance
        become: yes
        register: saltout

      - name: debug-message for state glance
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state neutron 1
        command: salt-call --hard-crash state.apply neutron
        become: yes

      - name: state neutron 2
        command: salt-call --hard-crash state.apply neutron
        become: yes
        register: saltout

      - name: debug-message for state neutron
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state nova.controller
        command: salt-call --hard-crash state.apply nova.controller
        become: yes
        register: saltout
        notify: restart nova

      - name: debug-message for state nova.controller
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state nova.compute
        command: salt-call --hard-crash state.apply nova.compute
        become: yes
        register: saltout
        notify: restart nova

      - name: debug-message for state nova.compute
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state cinder
        command: salt-call --hard-crash state.apply cinder
        become: yes
        register: saltout

      - name: debug-message for state cinder
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state heat
        command: salt-call --hard-crash state.apply heat
        become: yes
        register: saltout

      - name: debug-message for state heat
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

      - name: state horizon
        command: salt-call --hard-crash state.apply horizon
        register: result
        become: yes

      - name: debug-message for state horizon
        debug:
          msg: "{{ saltout.stdout_lines[-7:] }}"

    handlers:

      - name: restart nova
        service:
          name: "{{ item }}"
          state: restarted
        with_items:
          - nova-api
          - nova-compute
          - nova-consoleauth
          - nova-scheduler
          - nova-xenvncproxy
          - nova-cert
          - nova-conductor
          - nova-novncproxy
          - nova-spicehtml5proxy

        become: yes
