---

  - name: Install MCP
    hosts: all
    gather_facts: no
    become: yes
    tasks:

      - name: salt-call salt
        command: salt-call state.apply salt

      - name: state salt
        command: salt 'all01.local' state.apply salt

      - name: state linux,ntp,openssh
        command: salt 'all01.local' state.apply linux,ntp,openssh

      - name: state memcached
        command: salt 'all01.local' state.apply memcached

      - name: state rabbitmq
        command: salt 'all01.local' state.apply rabbitmq

      - name: state mysql
        command: salt 'all01.local' state.apply mysql

      - name: state keystone
        command: salt 'all01.local' state.apply keystone

      - name: state glance
        command: salt 'all01.local' state.apply glance

      - name: state neutron
        command: salt 'all01.local' state.apply neutron

      - name: state nova
        command: salt 'all01.local' state.apply nova
        notify: restart nova

      - name: state cinder
        command: salt 'all01.local' state.apply cinder

      - name: state heat
        command: salt 'all01.local' state.apply heat

      - name: state horizon
        command: salt 'all01.local' state.apply horizon
        notify: restart apache

      - name: state bind
        command: salt 'all01.local' state.apply bind

      - name: state designate
        command: salt 'all01.local' state.apply designate

    handlers:

      - name: restart nova
        service:
          name: "{{ item }}"
          state: restarted
        with_items:
          - nova-api
          - nova-compute
          - nova-consoleauth
          - nova-scheduler
          - nova-xenvncproxy
          - nova-cert
          - nova-conductor
          - nova-novncproxy
          - nova-spicehtml5proxy

      - name: restart apache
        service:
          name: apache2
          state: restarted
